# Stagg.co

Built with TypeScript, Node, Express, PostgreSQL, React, and Next; monorepo and package management provided by Lerna

## Getting Started

All steps listed below should be ran in the project root. You will only need to install dependencies to specific nested `apps/*`, `/packages/*`, or `/services/*` when adding a new dependency for a feature or bugfix that will be isolated to that app, package, or service, respectively.

Exclude all instructions below for the chart rendering service located in `/services/img.chart`; this open-source implementation is provided by [QuickChart](https://quickchart.io/) and does not require any additional setup or modification.

1. [Clone the repo](https://github.com/mdlindsey/stagg)
2. `npm i -g lerna` - needed for Lerna CLI below
3. `yarn install` - installs all common and workspace dependencies
4. `lerna link --force-local` - symlinks all internal `@stagg/*` dependencies to local compiled `/packages/*/lib`
5. `lerna run tsc` - updates local symlinked packages and propogates package updates throughout repo after modification
6. Setup environment variables (see below)
7. `yarn dev` - use in the root of any `/services/*` to start the service locally
8. `lerna publish` - use to publish changes to `/packages/*` to the NPM ecosystem (see more below)

### Secrets and Environment Variables

Secrets are managed with [Google Cloud Secret Manager](https://console.cloud.google.com/security/secret-manager). After being authorized to access this project's secrets, simply call the npm scripts `secrets:dev` for Unix platforms or `secrets:dev:win` for Windows platforms.

**For MacOS/Linux:**

```
# For yarn
yarn secrets:dev
```

```
# For npm
npm run secrets:dev
```

**For Windows:**

```
# For yarn
yarn secrets:dev:win
```

```
# For npm
npm run secrets:dev:win
```

You should specify which ports your local instances of applications will use by specifying a `PORT` environment variable along with the others generated by the commands above so that you may run multiple applications/services at once.

The environment variables `NODE_ENV=development` is required for `apps/web-ui` unless you want to run the production configuration without hot-reloading.

### Connecting to the database

You must use Google Cloud Proxy to connect from your local machine to the cloud database instance.

```
cd C:\Dev\Tools\GCP
cloud_sql_proxy_x64 --instances=stagcp:us-east1:production=tcp:5432
```

### Publishing to NPM

To publish new packages, you will need access to [Stagg NPM](https://www.npmjs.com/settings/stagg/packages). After gaining permissions to publish to this organization, use the following command to authenticate your local client.

```
npm login --registry=https://registry.npmjs.org/ --scope=stagg
```

### Ideas, fixes, features, etc

Potential problem with new scraper - if it goes offline for a while it will never capture beyond first 20 matches because it just keeps checking the end

Switch to RDB so individual match records/performances just relate back to a row from match details

**What will be free**
- Pull your own profile
- Discord text reports

**What will be premium**
- Pull other profiles
- Compare profiles
- Discord charts
- Discord rich views

**Fixes/Updates**
- Revert back to IDB store for downloaded match data
    
**Correlations**
- kills/avgLifeTime
- damageDone/timePlayed
- damageDone/damageTaken

**Ideas**
- Custom Discord roles
    - KD
    - SPM
    - Win/Top5/Top10 Rate
    - Correlations from above
- Alert when player beats previous best
    - Kills
    - Damage
    - Any win
- Comparison tooling
    - Match History endpoint returns stats for a single user, create a tool that can compare multiple users
    - Expand to the squad/server level to aggregate stats across a couple to a couple hundred accounts
