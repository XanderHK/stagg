timeout: 1800s
steps:
    - name: node:12.13.0
      entrypoint: yarn
      args: ['install']
    - name: node:12.13.0
      entrypoint: yarn
      args: ['gcp:tsc']
    - name: gcr.io/cloud-builders/gcloud
      entrypoint: 'bash'
      args: [ '-c', 'gcloud secrets versions access latest --secret=MONGO_HOST > build/.env.MONGO_HOST' ]
    - name: gcr.io/cloud-builders/gcloud
      entrypoint: 'bash'
      args: [ '-c', 'gcloud secrets versions access latest --secret=MONGO_USER > build/.env.MONGO_USER' ]
    - name: gcr.io/cloud-builders/gcloud
      entrypoint: 'bash'
      args: [ '-c', 'gcloud secrets versions access latest --secret=MONGO_PASS > build/.env.MONGO_PASS' ]
    - name: gcr.io/cloud-builders/gcloud
      entrypoint: 'bash'
      args: [ '-c', 'gcloud secrets versions access latest --secret=JWT_SECRET > build/.env.JWT_SECRET' ]
    - name: gcr.io/cloud-builders/gcloud
      entrypoint: 'bash'
      args: [ '-c', 'gcloud secrets versions access latest --secret=DISCORD_TOKEN > build/.env.DISCORD_TOKEN' ]
    - name: gcr.io/cloud-builders/gcloud
      entrypoint: 'bash'
      args: [ '-c', 'gcloud secrets versions access latest --secret=GMAIL_ADDRESS > build/.env.GMAIL_ADDRESS' ]
    - name: gcr.io/cloud-builders/gcloud
      entrypoint: 'bash'
      args: [ '-c', 'gcloud secrets versions access latest --secret=GMAIL_PASSWORD > build/.env.GMAIL_PASSWORD' ]
    - name: node:12.13.0
      entrypoint: yarn
      args: ['gcp:build']
    - name: gcr.io/cloud-builders/gcloud
      args: ['functions', 'deploy', 'render-chart', '--trigger-http', '--source=services/render-chart', '--entry-point=default', '--runtime=nodejs12', '--region=us-east1', '--memory=128MB']
    - name: gcr.io/cloud-builders/gcloud
      args: ['functions', 'deploy', 'render-view', '--trigger-http', '--source=services/render-view', '--entry-point=default', '--runtime=nodejs12', '--region=us-east1', '--memory=512MB']
    - name: gcr.io/cloud-builders/gcloud
      args: ['functions', 'deploy', 'scrape-cod-cron', '--trigger-http', '--source=services/scrape-cod-cron', '--entry-point=default', '--runtime=nodejs12', '--region=us-east1', '--memory=128MB']
    - name: gcr.io/cloud-builders/gcloud
      args: ['functions', 'deploy', 'scrape-cod-worker', '--trigger-http', '--source=services/scrape-cod-worker', '--entry-point=default', '--runtime=nodejs12', '--region=us-east1', '--memory=128MB', '--env-vars-file=services/scrape-cod-worker/.env.yaml']
    - name: gcr.io/cloud-builders/gcloud
      args: ['app', 'deploy', 'apps/api', '--version=production']
    - name: gcr.io/cloud-builders/gcloud
      args: ['app', 'deploy', 'apps/discord', '--version=production']
    - name: gcr.io/cloud-builders/gcloud
      args: ['app', 'deploy', 'apps/web-ui', '--version=production']
    - name: gcr.io/cloud-builders/gcloud
      args: ['app', 'deploy', 'dispatch.yaml', '--version=production']
